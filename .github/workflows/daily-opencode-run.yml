name: Daily OpenCode Run

on:
  schedule:
    # Runs every day at 8:00 AM UTC (cron format: minute hour day month weekday)
    - cron: '0 8 * * *'
  workflow_dispatch: # Allows manual trigger from GitHub UI
    inputs:
      custom_message:
        description: 'Custom message to send to OpenCode'
        required: false
        default: 'hello, env, var'

env:
  OPENCODE_MESSAGE: ${{ github.event.inputs.custom_message || secrets.OPENCODE_MESSAGE || vars.OPENCODE_MESSAGE || 'hello, env, var' }}
  # OpenCode AI provider credentials (configure in Settings > Secrets)
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  OPENCODE_ZEN_API_KEY: ${{ secrets.OPENCODE_ZEN_API_KEY }}
  # GitHub Copilot integration
  GITHUB_COPILOT_TOKEN: ${{ secrets.GH_COPILOT_TOKEN }}

jobs:
  run-opencode:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push changes back to repo
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Docker
        run: |
          docker --version
          echo "Docker is ready for OpenCode"
      
      - name: Prepare OpenCode authentication
        id: prepare-auth
        run: |
          # Create auth directory structure
          mkdir -p $HOME/.local/share/opencode
          mkdir -p $HOME/.config/opencode
          
          # Create auth.json based on available API keys
          AUTH_FILE="$HOME/.local/share/opencode/auth.json"
          
          echo "Creating OpenCode authentication file..."
          
          # Build auth JSON based on available credentials
          cat > "$AUTH_FILE" << 'EOF'
          {
            "credentials": []
          }
          EOF
          
          # Add Anthropic credentials if available
          if [ -n "$ANTHROPIC_API_KEY" ]; then
            echo "✅ Anthropic API key detected"
            echo "HAS_ANTHROPIC=true" >> $GITHUB_OUTPUT
          fi
          
          # Add OpenAI credentials if available
          if [ -n "$OPENAI_API_KEY" ]; then
            echo "✅ OpenAI API key detected"
            echo "HAS_OPENAI=true" >> $GITHUB_OUTPUT
          fi
          
          # Add OpenCode Zen credentials if available
          if [ -n "$OPENCODE_ZEN_API_KEY" ]; then
            echo "✅ OpenCode Zen API key detected"
            echo "HAS_ZEN=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for GitHub Copilot
          if [ -n "$GITHUB_COPILOT_TOKEN" ]; then
            echo "✅ GitHub Copilot token detected"
            echo "HAS_COPILOT=true" >> $GITHUB_OUTPUT
          fi
          
          echo "Auth preparation complete"
      
      - name: Create OpenCode project configuration
        run: |
          # Create AGENTS.md if it doesn't exist
          if [ ! -f "AGENTS.md" ]; then
            cat > AGENTS.md << 'EOF'
          # OpenCode Agent Configuration
          
          This is an automated GitHub Actions workflow that runs OpenCode daily.
          
          ## Instructions
          - Process the incoming message and provide a helpful response
          - Show environment information when requested
          - Display available variables and configuration
          - Always be concise and clear in responses
          EOF
            echo "Created default AGENTS.md"
          else
            echo "AGENTS.md already exists"
          fi
      
      - name: Run OpenCode in Docker
        id: opencode-run
        run: |
          echo "Running OpenCode with message: $OPENCODE_MESSAGE"
          
          # Create outputs directory
          mkdir -p docker-outputs
          
          # Generate filename with current date
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          OUTPUT_FILE="docker-outputs/opencode-output-${DATE}.txt"
          PROMPT_FILE="/tmp/opencode-prompt.txt"
          
          # Create prompt file with the message
          cat > "$PROMPT_FILE" << EOF
          $OPENCODE_MESSAGE
          
          Please also show:
          1. Current environment information
          2. Available configuration variables
          3. System information from the container
          EOF
          
          # Start output file
          echo "=== OpenCode Run Output ===" > "$OUTPUT_FILE"
          echo "Date: $(date -u)" >> "$OUTPUT_FILE"
          echo "Message: $OPENCODE_MESSAGE" >> "$OUTPUT_FILE"
          echo "GitHub Copilot Status: ${{ steps.prepare-auth.outputs.HAS_COPILOT && 'Enabled' || 'Not configured' }}" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          echo "=== Environment Info ===" >> "$OUTPUT_FILE"
          echo "Runner OS: $RUNNER_OS" >> "$OUTPUT_FILE"
          echo "Workflow: $GITHUB_WORKFLOW" >> "$OUTPUT_FILE"
          echo "Repository: $GITHUB_REPOSITORY" >> "$OUTPUT_FILE"
          echo "" >> "$OUTPUT_FILE"
          
          # Run OpenCode in Docker container
          echo "=== OpenCode Docker Execution ===" >> "$OUTPUT_FILE"
          
          # Use the official OpenCode Docker image
          docker run --rm \
            -v "$(pwd)":/workspace \
            -w /workspace \
            -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY}" \
            -e OPENAI_API_KEY="${OPENAI_API_KEY}" \
            -e OPENCODE_ZEN_API_KEY="${OPENCODE_ZEN_API_KEY}" \
            -e GITHUB_COPILOT_TOKEN="${GITHUB_COPILOT_TOKEN}" \
            ghcr.io/sst/opencode:latest \
            /bin/bash -c "echo 'OpenCode Docker Container Started' && \
              echo 'Message to process: $OPENCODE_MESSAGE' && \
              echo 'Environment variables available:' && \
              env | grep -E '(ANTHROPIC|OPENAI|OPENCODE|COPILOT|GITHUB)' | sed 's/=.*/=***/' && \
              echo '' && \
              echo 'Container Info:' && \
              uname -a && \
              echo 'OpenCode version:' && \
              opencode --version 2>&1 || echo 'OpenCode CLI check complete' && \
              echo '' && \
              echo 'Workspace contents:' && \
              ls -la /workspace" >> "$OUTPUT_FILE" 2>&1 || echo "OpenCode execution completed" >> "$OUTPUT_FILE"
          
          echo "" >> "$OUTPUT_FILE"
          echo "=== Execution Summary ===" >> "$OUTPUT_FILE"
          echo "Completed at: $(date -u)" >> "$OUTPUT_FILE"
          
          # Save filename for later steps
          echo "filename=$OUTPUT_FILE" >> $GITHUB_OUTPUT
          
          # Display the output
          echo "Output file contents:"
          cat "$OUTPUT_FILE"
          
          echo "✅ OpenCode run completed successfully"
      
      - name: Generate run summary
        run: |
          OUTPUT_FILE="${{ steps.opencode-run.outputs.filename }}"
          
          echo "## OpenCode Daily Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Message:** \`$OPENCODE_MESSAGE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration Status" >> $GITHUB_STEP_SUMMARY
          echo "- Anthropic API: ${{ steps.prepare-auth.outputs.HAS_ANTHROPIC && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenAI API: ${{ steps.prepare-auth.outputs.HAS_OPENAI && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenCode Zen: ${{ steps.prepare-auth.outputs.HAS_ZEN && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Copilot: ${{ steps.prepare-auth.outputs.HAS_COPILOT && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output File" >> $GITHUB_STEP_SUMMARY
          echo "\`$OUTPUT_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for complete output." >> $GITHUB_STEP_SUMMARY
      
      - name: Commit and push output
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docker-outputs/
          git add AGENTS.md 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add OpenCode run output for $(date +%Y-%m-%d)"
            git push
            echo "✅ Changes pushed successfully"
          fi
      
      - name: Upload output as artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencode-output-${{ github.run_number }}
          path: ${{ steps.opencode-run.outputs.filename }}
          retention-days: 30
      
      - name: Upload AGENTS.md as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: agents-config-${{ github.run_number }}
          path: AGENTS.md
          retention-days: 7
