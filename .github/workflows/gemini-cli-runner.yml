name: Tech News Digest Generator

on:
  schedule:
    # Runs daily at 9:00 AM UTC to generate fresh news digest
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual trigger from GitHub UI
    inputs:
      focus_areas:
        description: 'Specific focus areas (e.g., "AI/ML, Security, Cloud")'
        required: false
        default: ''
      max_items_per_category:
        description: 'Maximum news items per category'
        required: false
        default: '5'

jobs:
  generate-news-digest:
    runs-on: ubuntu-latest
    environment: Gemini
    permissions:
      contents: write # Required to push HTML digest back to repo
      id-token: write # Required for Workload Identity Federation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get current date
        id: get-date
        run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
      
      - name: Generate Tech News Digest
        id: generate-digest
        uses: google-github-actions/run-gemini-cli@v0
        env:
          CURRENT_DATE: ${{ steps.get-date.outputs.date }}
          FOCUS_AREAS: ${{ github.event.inputs.focus_areas || 'AI/ML, Security, Cloud, DevOps, Programming Languages' }}
          MAX_ITEMS: ${{ github.event.inputs.max_items_per_category || '5' }}
        with:
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION || 'latest' }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          upload_artifacts: true
          workflow_name: 'tech-news-digest'
          prompt: |
            You are a technical intelligence curator for software professionals and academics. Generate a comprehensive tech news digest.

            ## CONTEXT
            - Current Date: ${CURRENT_DATE}
            - Focus Areas: ${FOCUS_AREAS}
            - Max Items Per Category: ${MAX_ITEMS}

            ## NEWS DISCOVERY FRAMEWORK

            ### Phase 1: Multi-Dimensional Scan
            Search across these dimensions:

            **A. Breakthrough Research & Innovation**
            - Recent papers on arXiv (cs.SE, cs.AI, cs.PL, cs.DC, cs.CR, cs.DB)
            - Conference proceedings (ICSE, FSE, PLDI, OSDI, SOSP, NeurIPS, SIGMOD)
            - Novel algorithms, formal methods, theoretical advances

            **B. Production-Ready Technology**
            - New stable releases of major frameworks/languages
            - Adoption patterns in production environments
            - Tooling improvements (developer productivity, observability, security)

            **C. Architectural & Paradigm Shifts**
            - Evolving patterns in system design
            - Infrastructure evolution (cloud-native, edge computing, serverless)
            - Programming paradigm adoption

            **D. Security & Compliance Landscape**
            - Critical CVEs and vulnerability disclosures (CISA KEV, NVD)
            - Zero-day exploits and mitigation strategies
            - Regulatory changes

            **E. Industry Intelligence**
            - Major tech company engineering blogs
            - Open source project trajectories
            - Developer survey insights

            ### Phase 2: Signal Extraction

            **Relevance Scoring:**
            - Critical (‚≠ê‚≠ê‚≠ê): Immediate impact, security-critical, paradigm-shifting
            - Important (‚≠ê‚≠ê): Emerging best practices, growing adoption
            - Awareness (‚≠ê): Experimental, early-stage

            **Actionability Assessment:**
            - Immediate Action: Requires updates, patches
            - Strategic Planning: 3-6 month roadmaps
            - Monitor & Learn: Track evolution, experiment
            - Long-term Watch: Revisit in 6-12 months

            ## CRITICAL OUTPUT REQUIREMENTS

            **YOU MUST:**
            1. Generate a complete, self-contained interactive HTML file
            2. Save it as: tech-digest-${CURRENT_DATE}.html in the repository root
            3. Include all 6 categories: Critical Updates, Research Breakthroughs, Production Technology, Architectural Evolution, Industry Signals, Emerging Horizons
            4. Validate ALL links before inclusion - use only working URLs
            5. Use dark theme design with modern, responsive layout
            6. Include collapsible sections for each category
            7. Each news item must have: title, badges (relevance + actionability), description, verified source link, and detail sections (Why It Matters, Recommended Action, Learning Resources)

            ## HTML STRUCTURE REQUIREMENTS

            Create a complete HTML document with:
            - DOCTYPE html declaration
            - Meta tags for UTF-8 and viewport
            - Title: "Tech Intelligence Digest - ${CURRENT_DATE}"
            - Embedded CSS with dark theme variables:
              * --critical: #dc2626
              * --research: #7c3aed
              * --production: #059669
              * --architecture: #0891b2
              * --industry: #ea580c
              * --emerging: #6366f1
              * Dark backgrounds: #0f172a, #1e293b, #334155
            
            - Header with gradient title and metadata
            - Stats bar showing counts for each category
            - Six category sections, each with:
              * Category header with icon and toggle button
              * Collapsible content area
              * News items with structured data
            
            - Each news item structure:
              ```html
              <div class="news-item">
                <div class="item-header">
                  <h3 class="item-title">{Title}</h3>
                  <div class="badges">
                    <span class="badge {critical|important|awareness}">{Relevance}</span>
                    <span class="badge {immediate|strategic|monitor|watch}">{Actionability}</span>
                  </div>
                </div>
                <p class="item-description">{Description}</p>
                <a href="{verified_url}" class="source-link" target="_blank">Original Source: {source_name}</a>
                <div class="item-details">
                  <div class="detail-section">
                    <h4>üí° Why It Matters</h4>
                    <p>{Impact explanation}</p>
                  </div>
                  <div class="detail-section">
                    <h4>‚ö° Recommended Action</h4>
                    <p>{Next steps}</p>
                  </div>
                  <div class="detail-section">
                    <h4>üìö Learning Resources</h4>
                    <div class="resources">
                      <a href="{url}" class="resource-link" target="_blank">{Resource Name}</a>
                    </div>
                  </div>
                </div>
              </div>
              ```
            
            - JavaScript for toggle functionality:
              ```javascript
              function toggleCategory(header) {
                const content = header.nextElementSibling;
                const button = header.querySelector('.toggle-btn');
                if (content.classList.contains('collapsed')) {
                  content.classList.remove('collapsed');
                  button.classList.remove('collapsed');
                  button.classList.add('expanded');
                } else {
                  content.classList.add('collapsed');
                  button.classList.remove('expanded');
                  button.classList.add('collapsed');
                }
              }
              ```
            
            - Footer with generation metadata

            ## EXECUTION STEPS

            1. Perform Multi-Dimensional Scan using available search tools
            2. Extract signals and evaluate relevance/actionability
            3. **Validate all URLs** - test each link, replace broken ones or mark unavailable
            4. Count items per category for stats bar
            5. Generate complete HTML with proper styling
            6. **Save file as: tech-digest-${CURRENT_DATE}.html**
            7. Ensure file is browser-ready (no external dependencies)

            ## QUALITY CRITERIA
            ‚úÖ All links verified and working
            ‚úÖ Balanced across experience levels
            ‚úÖ Verifiable from primary sources
            ‚úÖ Clear relevance to professional practice
            ‚úÖ Honest about maturity levels and risks
            ‚úÖ Actionable recommendations for each item

            Begin generating the digest now. Save the complete HTML file to tech-digest-${CURRENT_DATE}.html
      
      - name: Generate workflow summary
        if: always()
        run: |
          ERROR="${{ steps.generate-digest.outputs.error }}"
          DATE=$(date +%Y-%m-%d)
          
          echo "## üöÄ Tech News Digest Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u --iso-8601=seconds)" >> $GITHUB_STEP_SUMMARY
          echo "**Focus Areas:** ${{ github.event.inputs.focus_areas || 'AI/ML, Security, Cloud, DevOps, Programming Languages' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$ERROR" ]; then
            echo "### ‚ùå Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$ERROR" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ Digest Generated Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìÑ **Output File:** \`tech-digest-${DATE}.html\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The interactive HTML digest has been generated and will be committed to the repository." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Features:**" >> $GITHUB_STEP_SUMMARY
            echo "- üö® Critical security updates" >> $GITHUB_STEP_SUMMARY
            echo "- üî¨ Latest research breakthroughs" >> $GITHUB_STEP_SUMMARY
            echo "- üõ†Ô∏è Production-ready technologies" >> $GITHUB_STEP_SUMMARY
            echo "- üèóÔ∏è Architectural evolution insights" >> $GITHUB_STEP_SUMMARY
            echo "- üìä Industry signals and trends" >> $GITHUB_STEP_SUMMARY
            echo "- üîÆ Emerging horizons" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Verify HTML digest file
        id: verify-digest
        run: |
          DATE=$(date +%Y-%m-%d)
          DIGEST_FILE="tech-digest-${DATE}.html"
          
          if [ -f "$DIGEST_FILE" ]; then
            echo "‚úÖ HTML digest generated successfully: $DIGEST_FILE"
            FILE_SIZE=$(stat -f%z "$DIGEST_FILE" 2>/dev/null || stat -c%s "$DIGEST_FILE" 2>/dev/null)
            echo "üìä File size: ${FILE_SIZE} bytes"
            echo "digest_file=$DIGEST_FILE" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è HTML digest file not found at expected location: $DIGEST_FILE"
            echo "Checking repository root for generated files..."
            ls -la *.html 2>/dev/null || echo "No HTML files found in root"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push HTML digest to tech-digest branch
        if: steps.verify-digest.outputs.file_exists == 'true'
        run: |
          DATE=$(date +%Y-%m-%d)
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Fetch all branches
          git fetch origin
          
          # Check if tech-digest branch exists, create or checkout
          if git show-ref --quiet refs/heads/tech-digest; then
            echo "üìå Checking out existing tech-digest branch"
            git checkout tech-digest
          elif git show-ref --quiet refs/remotes/origin/tech-digest; then
            echo "üìå Checking out remote tech-digest branch"
            git checkout -b tech-digest origin/tech-digest
          else
            echo "üÜï Creating new tech-digest branch"
            git checkout -b tech-digest
          fi
          
          # Add generated HTML digest file
          git add "tech-digest-${DATE}.html"
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit (digest may already exist)"
          else
            git commit -m "Add Tech News Digest for ${DATE}" \
              -m "Generated interactive HTML digest covering:" \
              -m "- Critical security updates and vulnerabilities" \
              -m "- Latest research breakthroughs from academia" \
              -m "- Production-ready technology releases" \
              -m "- Architectural evolution and best practices" \
              -m "- Industry signals and adoption trends" \
              -m "- Emerging technologies and innovations" \
              -m "" \
              -m "File: tech-digest-${DATE}.html"
            
            git push -u origin tech-digest
            echo "‚úÖ Tech digest pushed successfully to tech-digest branch!"
            echo "üìÑ View at: tech-digest-${DATE}.html"
            echo "üåø Branch: tech-digest"
          fi
