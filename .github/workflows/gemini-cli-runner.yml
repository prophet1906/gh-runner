name: Gemini CLI Task Runner

on:
  schedule:
    # Runs every day at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual trigger from GitHub UI
    inputs:
      query:
        description: 'Task query to execute with Gemini CLI'
        required: true
        default: 'Analyze this repository and provide insights about its structure and purpose'

jobs:
  run-gemini-task:
    runs-on: ubuntu-latest
    environment: Gemini
    permissions:
      contents: write # Required to push changes back to repo
      id-token: write # Required for Workload Identity Federation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for better context
      
      - name: Create output directory
        run: mkdir -p gemini-outputs
      
      - name: Run Gemini CLI
        id: run-gemini
        uses: google-github-actions/run-gemini-cli@v0
        env:
          QUERY: ${{ github.event.inputs.query || vars.GEMINI_QUERY || 'Analyze this repository structure and provide a summary' }}
          REPOSITORY: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          WORKFLOW: ${{ github.workflow }}
          RUN_NUMBER: ${{ github.run_number }}
          TRIGGERED_BY: ${{ github.event_name }}
        with:
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION || 'latest' }}
          gemini_debug: ${{ fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || 'false') }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          use_gemini_code_assist: ${{ vars.GOOGLE_GENAI_USE_GCA }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          upload_artifacts: true
          workflow_name: 'gemini-cli-runner'
          prompt: |-
            ${QUERY}
            
            Repository Context:
            - Repository: ${REPOSITORY}
            - Branch: ${BRANCH}
            - Workflow: ${WORKFLOW}
            - Run Number: ${RUN_NUMBER}
            - Triggered by: ${TRIGGERED_BY}
            
            Please analyze the repository and provide a comprehensive response.
      
      - name: Generate run summary
        if: always()
        run: |
          SUMMARY="${{ steps.run-gemini.outputs.summary }}"
          ERROR="${{ steps.run-gemini.outputs.error }}"
          
          echo "## Gemini CLI Task Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Query:** \`${{ github.event.inputs.query || vars.GEMINI_QUERY || 'Default analysis query' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$ERROR" ]; then
            echo "### ❌ Error" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$ERROR" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [ -n "$SUMMARY" ]; then
            echo "### ✅ Result" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No output generated. Check execution logs." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See artifacts for complete output and logs." >> $GITHUB_STEP_SUMMARY
      
      - name: Save result to file
        if: steps.run-gemini.outputs.summary != ''
        run: |
          DATE=$(date +%Y-%m-%d_%H-%M-%S)
          OUTPUT_FILE="gemini-outputs/gemini-result-${DATE}.md"
          
          cat > "$OUTPUT_FILE" << 'EOF'
          # Gemini CLI Task Result
          
          **Date:** $(date -u --iso-8601=seconds)
          **Repository:** ${{ github.repository }}
          **Query:** ${{ github.event.inputs.query || vars.GEMINI_QUERY || 'Default analysis query' }}
          
          ---
          
          ${{ steps.run-gemini.outputs.summary }}
          EOF
          
          echo "✅ Result saved to $OUTPUT_FILE"
          echo "output_file=$OUTPUT_FILE" >> $GITHUB_OUTPUT
      
      - name: Commit and push results
        if: steps.run-gemini.outputs.summary != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add gemini-outputs/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add Gemini CLI task results for $(date +%Y-%m-%d)"
            git push
            echo "✅ Changes pushed successfully to repository"
          fi
