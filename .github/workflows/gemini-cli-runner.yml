name: Tech News Digest Generator

on:
  schedule:
    # Runs daily at 9:00 AM UTC to generate fresh news digest
    - cron: '0 9 * * *'
  workflow_dispatch: # Allows manual trigger from GitHub UI
    inputs:
      focus_areas:
        description: 'Specific focus areas (e.g., "AI/ML, Security, Cloud")'
        required: false
        default: ''
      max_items_per_category:
        description: 'Maximum news items per category'
        required: false
        default: '5'

jobs:
  generate-news-digest:
    runs-on: ubuntu-latest
    environment: Gemini
    permissions:
      contents: write # Required to push HTML digest back to repo
      id-token: write # Required for Workload Identity Federation
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate Tech News Digest
        id: generate-digest
        uses: google-github-actions/run-gemini-cli@v0
        env:
          CURRENT_DATE: ${{ steps.get-date.outputs.date }}
          FOCUS_AREAS: ${{ github.event.inputs.focus_areas || 'AI/ML, Security, Cloud, DevOps, Programming Languages' }}
          MAX_ITEMS: ${{ github.event.inputs.max_items_per_category || '5' }}
        with:
          gcp_location: ${{ vars.GOOGLE_CLOUD_LOCATION }}
          gcp_project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          gcp_service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}
          gcp_workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_cli_version: ${{ vars.GEMINI_CLI_VERSION || 'latest' }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          use_vertex_ai: ${{ vars.GOOGLE_GENAI_USE_VERTEXAI }}
          upload_artifacts: true
          workflow_name: 'tech-news-digest'
          prompt_file: 'news.md'
          prompt: |-
            Generate today's tech news digest following the complete framework in news.md.
            
            **Context:**
            - Current Date: ${CURRENT_DATE}
            - Focus Areas: ${FOCUS_AREAS}
            - Max Items Per Category: ${MAX_ITEMS}
            
            **Requirements:**
            1. Generate a complete, interactive HTML file following the exact template in news.md
            2. Include all 6 categories: Critical Updates, Research Breakthroughs, Production Technology, Architectural Evolution, Industry Signals, Emerging Horizons
            3. Validate ALL links before inclusion - use only working URLs
            4. Save the output as: tech-digest-${CURRENT_DATE}.html in the repository root directory
            5. Ensure the HTML is self-contained and can be opened directly in a browser
            
            Execute the Multi-Dimensional Scan across research papers, security advisories, tech blogs, and open source releases.
      
      - name: Get current date
        id: get-date
        run: echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
      
      - name: Generate workflow summary
        if: always()
        run: |
          ERROR="${{ steps.generate-digest.outputs.error }}"
          DATE=$(date +%Y-%m-%d)
          
          echo "## ğŸš€ Tech News Digest Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated:** $(date -u --iso-8601=seconds)" >> $GITHUB_STEP_SUMMARY
          echo "**Focus Areas:** ${{ github.event.inputs.focus_areas || 'AI/ML, Security, Cloud, DevOps, Programming Languages' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$ERROR" ]; then
            echo "### âŒ Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$ERROR" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Digest Generated Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“„ **Output File:** \`tech-digest-${DATE}.html\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The interactive HTML digest has been generated and will be committed to the repository." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Features:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸš¨ Critical security updates" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”¬ Latest research breakthroughs" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ› ï¸ Production-ready technologies" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ—ï¸ Architectural evolution insights" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Industry signals and trends" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”® Emerging horizons" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Verify HTML digest file
        id: verify-digest
        run: |
          DATE=$(date +%Y-%m-%d)
          DIGEST_FILE="tech-digest-${DATE}.html"
          
          if [ -f "$DIGEST_FILE" ]; then
            echo "âœ… HTML digest generated successfully: $DIGEST_FILE"
            FILE_SIZE=$(stat -f%z "$DIGEST_FILE" 2>/dev/null || stat -c%s "$DIGEST_FILE" 2>/dev/null)
            echo "ğŸ“Š File size: ${FILE_SIZE} bytes"
            echo "digest_file=$DIGEST_FILE" >> $GITHUB_OUTPUT
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ HTML digest file not found at expected location: $DIGEST_FILE"
            echo "Checking repository root for generated files..."
            ls -la *.html 2>/dev/null || echo "No HTML files found in root"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push HTML digest to tech-digest branch
        if: steps.verify-digest.outputs.file_exists == 'true'
        run: |
          DATE=$(date +%Y-%m-%d)
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Fetch all branches
          git fetch origin
          
          # Check if tech-digest branch exists, create or checkout
          if git show-ref --quiet refs/heads/tech-digest; then
            echo "ğŸ“Œ Checking out existing tech-digest branch"
            git checkout tech-digest
          elif git show-ref --quiet refs/remotes/origin/tech-digest; then
            echo "ğŸ“Œ Checking out remote tech-digest branch"
            git checkout -b tech-digest origin/tech-digest
          else
            echo "ğŸ†• Creating new tech-digest branch"
            git checkout -b tech-digest
          fi
          
          # Add generated HTML digest file
          git add "tech-digest-${DATE}.html"
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit (digest may already exist)"
          else
            git commit -m "Add Tech News Digest for ${DATE}" \
              -m "Generated interactive HTML digest covering:" \
              -m "- Critical security updates and vulnerabilities" \
              -m "- Latest research breakthroughs from academia" \
              -m "- Production-ready technology releases" \
              -m "- Architectural evolution and best practices" \
              -m "- Industry signals and adoption trends" \
              -m "- Emerging technologies and innovations" \
              -m "" \
              -m "File: tech-digest-${DATE}.html"
            
            git push -u origin tech-digest
            echo "âœ… Tech digest pushed successfully to tech-digest branch!"
            echo "ğŸ“„ View at: tech-digest-${DATE}.html"
            echo "ğŸŒ¿ Branch: tech-digest"
          fi
